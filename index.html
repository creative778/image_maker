<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bangla Image OCR & Watermark Remover</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik+Moonrocks&display=swap" rel="stylesheet">
<style>
  body {font-family: Arial, sans-serif; max-width: 900px; margin: 2rem auto; padding:0 1rem;}
  h1 {text-align:center;}
  #drop-zone {
    border: 2px dashed #aaa; border-radius: 10px; padding: 2rem; text-align:center;
    color:#666; cursor:pointer; margin-bottom:1rem;
  }
  #drop-zone.hover {border-color:#666; background:#f9f9f9;}
  .container {display: flex; gap: 2rem; margin-top:2rem;}
  .preview {flex:1;}
  .preview img, .preview canvas {max-width:100%; border:1px solid #ddd; margin:0.5rem 0;}
  button {margin-top:0.5rem; padding:0.5rem 1rem; font-size:1rem; cursor:pointer;}
  #status {margin-top:0.5rem; font-size:0.9rem; color:#555;}
  textarea {width:100%; height:150px; padding:0.5rem; font-family:monospace;}
</style>
</head>
<body>

<h1>üñºÔ∏è Bangla Image OCR & Watermark Remover</h1>

<div id="drop-zone">
  Click or drag‚Äë&‚Äëdrop an image here<br>
  (or paste with <kbd>Ctrl+V</kbd>)
</div>

<input type="file" id="file-input" accept="image/*" style="display:none">
<div id="status"></div>

<div class="container">
  <div class="preview">
    <h3>Original Image</h3>
    <img id="original-img" style="display:none;">
  </div>
  <div class="preview">
    <h3>Watermark Removed</h3>
    <canvas id="cleaned-canvas" style="display:none;"></canvas>
  </div>
</div>

<h3>Extracted Bangla Text</h3>
<textarea id="text-output" readonly></textarea>
<button id="copy-btn" style="display:none;">üìã Copy Text</button>

<h3>Create Styled Image</h3>
<input type="text" id="bg-color" value="#f0f0f0" placeholder="Background color (hex)">
<button id="create-btn" style="display:none;">‚ú® Create Styled Image</button>

<h3>Output</h3>
<canvas id="output-canvas" style="display:none;"></canvas>
<button id="download-btn" style="display:none;">üíæ Download Image</button>

<!-- Tesseract.js with Bangla support -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>

<script>
/* ========== HELPER FUNCTIONS ========== */
function showStatus(msg, error = false) {
  const s = document.getElementById('status');
  s.textContent = msg;
  s.style.color = error ? 'red' : '#555';
}

/* ========== DETECT & REMOVE WATERMARKS ========== */
function removeWatermarks(canvas) {
  const ctx = canvas.getContext('2d');
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  // Detect light areas (likely watermarks) and make them white
  for (let i = 0; i < data.length; i += 4) {
    const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
    const brightness = (r + g + b) / 3;
    
    // If area is very light (> 200), assume it's watermark
    if (brightness > 200 && a > 200) {
      data[i] = 255;     // R
      data[i+1] = 255;   // G
      data[i+2] = 255;   // B
    }
  }

  ctx.putImageData(imageData, 0, 0);
}

/* ========== IMAGE INPUT ========== */
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
let uploadedImg = null;

dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.classList.add('hover');
});

dropZone.addEventListener('dragleave', () => dropZone.classList.remove('hover'));

dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('hover');
  handleFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', e => {
  if (e.target.files[0]) handleFile(e.target.files[0]);
});

document.addEventListener('paste', e => {
  const items = e.clipboardData?.items;
  if (!items) return;
  for (const i of items) {
    if (i.type.startsWith('image/')) {
      handleFile(i.getAsFile());
      break;
    }
  }
});

function handleFile(file) {
  if (!file.type.startsWith('image/')) {
    showStatus('Please select a valid image file.', true);
    return;
  }
  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => {
      uploadedImg = img;
      
      // Display original
      document.getElementById('original-img').src = img.src;
      document.getElementById('original-img').style.display = 'block';
      
      // Create cleaned version
      const cleanedCanvas = document.getElementById('cleaned-canvas');
      cleanedCanvas.width = img.width;
      cleanedCanvas.height = img.height;
      const ctx = cleanedCanvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      removeWatermarks(cleanedCanvas);
      cleanedCanvas.style.display = 'block';
      
      startOCR(cleanedCanvas);
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

/* ========== OCR WITH BANGLA ========== */
async function startOCR(canvas) {
  showStatus('Running Bangla OCR ‚Äì please wait...');
  
  try {
    const { data: { text } } = await Tesseract.recognize(
      canvas,
      'ben',  // Bangla language code
      { logger: m => showStatus(`OCR: ${m.status} (${Math.round(m.progress*100)}%)`) }
    );

    const cleanText = text.trim();
    if (!cleanText) {
      showStatus('‚ö†Ô∏è No readable text found. Try a clearer image.', true);
      return;
    }

    document.getElementById('text-output').value = cleanText;
    showStatus('‚úÖ Text extracted successfully!');
    document.getElementById('copy-btn').style.display = 'inline-block';
    document.getElementById('create-btn').style.display = 'inline-block';
  } catch (err) {
    showStatus('‚ùå OCR Error: ' + err.message, true);
  }
}

/* ========== COPY TEXT ========== */
document.getElementById('copy-btn').addEventListener('click', () => {
  const text = document.getElementById('text-output').value;
  navigator.clipboard.writeText(text).then(() => {
    showStatus('‚úÖ Copied to clipboard!');
  });
});

/* ========== CREATE STYLED IMAGE ========== */
document.getElementById('create-btn').addEventListener('click', () => {
  const text = document.getElementById('text-output').value;
  const bgColor = document.getElementById('bg-color').value || '#f0f0f0';

  const canvas = document.getElementById('output-canvas');
  canvas.width = 1000;
  canvas.height = 700;
  const ctx = canvas.getContext('2d');

  // Draw background
  ctx.fillStyle = bgColor;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Draw text
  ctx.fillStyle = '#333';
  ctx.font = '32px "Noto Sans Bengali", Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  wrapText(ctx, text, canvas.width / 2, canvas.height / 2 - 50, canvas.width * 0.85, 40);

  // Draw "ARS" logo
  ctx.fillStyle = '#ff5722';
  ctx.font = 'bold 90px "Rubik Moonrocks", cursive';
  ctx.textAlign = 'right';
  ctx.textBaseline = 'bottom';
  ctx.fillText('ARS', canvas.width - 40, canvas.height - 40);

  canvas.style.display = 'block';
  document.getElementById('download-btn').style.display = 'inline-block';
  showStatus('‚úÖ Styled image created!');
});

/* ========== TEXT WRAPPING ========== */
function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split(/\s+/);
  let line = '';
  const lines = [];
  
  for (let n = 0; n < words.length; n++) {
    const testLine = line + words[n] + ' ';
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && n > 0) {
      lines.push(line.trim());
      line = words[n] + ' ';
    } else {
      line = testLine;
    }
  }
  lines.push(line.trim());

  const startY = y - (lines.length - 1) * lineHeight / 2;
  for (let i = 0; i < lines.length; i++) {
    ctx.fillText(lines[i], x, startY + i * lineHeight);
  }
}

/* ========== DOWNLOAD ========== */
document.getElementById('download-btn').addEventListener('click', () => {
  const canvas = document.getElementById('output-canvas');
  const link = document.createElement('a');
  link.href = canvas.toDataURL('image/png');
  link.download = `ARS-${Date.now()}.png`;
  link.click();
});

// Load Bangla font support
const link = document.createElement('link');
link.href = 'https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali&display=swap';
link.rel = 'stylesheet';
document.head.appendChild(link);
</script>

</body>
</html>
